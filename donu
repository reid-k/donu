#!/usr/bin/env python2
#encoding=UTF-8

import os
import sys
from subprocess import call
from configobj import ConfigObj

#TODO: Paging and such
if len(sys.argv)<2: sys.exit("Usage:\n donu <URL or file>")

confpath = os.getenv("HOME") + "/.donu.conf"
config = ConfigObj(confpath)
page = 0
browsers = []
protocol = sys.argv[1][:sys.argv[1].find(":")]

try:
    for program in config[protocol]:
        browsers += [str(config[protocol][program])]
except KeyError:
    sys.exit("Key Error when reading " + protocol + " from " + confpath)

def drawscreen():
    print("Giving this:\n")
    print(sys.argv[1]+"\n")
    print("To:\n")
    for i in range(0,len(browsers)):
        entry = ''
        entry += str(browsers[i])
        if i==0:
            entry += " (Default)"
        print(str(i+1)+": "+ entry)
    #if (len(browsers)>10): 
    #    print "p or n for more options"
    print("Or q to cancel")

def pass_uri(selection=1):
    call((browsers[int(selection)-1] + " " + sys.argv[1]).split())
    sys.exit()

while True:
    if len(browsers) == 1:
        pass_uri()
        break
    drawscreen()

    theinput = raw_input('? ').lower()

    if theinput == '':
        theinput = '1'
    if theinput == 'e':
        print("Editing NYI")
        continue
    if theinput == 'c':
        print("Configuration NYI")
        continue
    if theinput == 'q':
        sys.exit()
    #if theinput == 'n' and len(browsers) > page * 10:
    #    page += 1
    #    continue
    #if theinput == 'p' and page > 0:
    #    page -= 1
    #    continue
    if theinput == 'r':
        sys.argv[1]+= "/.compact"
        continue

    try:
        pass_uri(theinput)
        break
    except (IndexError, ValueError):
        print("Invalid selection\n")
